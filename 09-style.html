<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: Automation and Make</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <article>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
                    <a href="index.html"><h1 class="title">Automation and Make</h1></a>
          <h2 class="subtitle">A few style notes</h2>
          <p>Make is a very flexible tool for keeping track of dependencies. It’s therefore not surprising that there’s more than one way to write a Makefile, and no one ‘correct’ way.</p>
<p>The only ordering that matters to <code>make</code> is that the first <em>non-pattern</em> rule in the file (that is, the first rule that doesn’t involve the <code>%</code> wildcards) is the default rule. Apart from that, you are free to have the rules in almost any order that makes sense to you. That said, it’s generally a good idea to keep variable definitions at the top of the file, where you can find them, and <em>possibly</em> a good idea to keep all of the pattern rules there, too.</p>
<p>There are no targets <em>required</em> in Makefiles, but there are a few which are conventional.</p>
<ul>
<li><p><code>all</code>: Often, the first target in the Makefile is <code>all</code> (and hence the default), which names the actual default target, which therefore doesn’t have to be located first in the Makefile, if it’s more sensible for it to be elsewhere. It means you can type <code>make all</code> and <code>make</code> does The Right Thing.</p></li>
<li><p><code>clean</code>: It’s <em>always</em> a good idea to have a <code>clean</code> target. Otherwise, it’s far too easy, when tweaking your Makefile, to mistype <code>rm *.something</code> and delete non-generated files.</p></li>
<li><p><code>dist</code>: Bundling up your data and code, to give to someone else, is often quite an intricate process. Being able to type <code>make dist</code> takes the anguish out of it.</p></li>
<li><p><code>check</code>: You <em>do</em> have unit tests, don’t you? In the example in this lesson, they would be rather artificial, but in a project where you do have them, then whenever you can’t think what else to do, your fingers should automatically type <code>make check</code> so you can get the warm glow of seeing all your tests pass.</p></li>
</ul>
<p>The real power of Make comes from its ability to keep track of dependencies; you can do a lot with just that. GNU Make contains a lot of functionality beyond ‘traditional’ Make, and it’s possible to use this to create extremely complicated Makefiles. Don’t feel obliged to use all of this functionality. When I need to add sophistication, and where I have a choice, I generally think it’s clearer to add complication to the rules rather than in the Makefile, since the rules are, after all, mini-shell scripts.</p>
<p>Overall: keep it simple, as much as you can.</p>
<p>Thus, the way <em>I</em> would write the final Makefile is like this:</p>
<pre class="make"><code># Count words script.
COUNT_SRC=wordcount.py

# Plot word counts script.
PLOT_SRC=plotcount.py

# If we need to use a particular version of Python for some reason,
# then we should change this variable,
# or override it with a full path on the make command line.
PYTHON=python


TXT_FILES=$(wildcard books/*.txt)
DAT_FILES=$(patsubst books/%.txt, %.dat, $(TXT_FILES))
PNG_FILES=$(patsubst books/%.txt, %.png, $(TXT_FILES))


%.dat : books/%.txt $(COUNT_SRC)
    $(PYTHON) $(COUNT_SRC) $&lt; $@

%.png : %.dat $(PLOT_SRC)
    $(PYTHON) $(PLOT_SRC) $&lt; $@


# The default target is the distribution tarball
all: dist

dist: analysis.tar.gz

# Generate archive file from the distribution directory
analysis.tar.gz: analysis
    tar -czf $@ $^

# Bundle all of the distributed files into a separate directory
# (it&#39;s good manners, in a tarball, to have all the contents unpacking
# into a single directory)
analysis: $(DAT_FILES) $(PNG_FILES) $(COUNT_SRC) $(PLOT_SRC)
    mkdir analysis
    cp $^ analysis

check:
    @echo &quot;No unit tests in this project&quot;

clean:
    rm -f $(DAT_FILES) $(PNG_FILES) analysis.tar.gz
    rm -Rf analysis

variables:
    @echo TXT_FILES: $(TXT_FILES)
    @echo DAT_FILES: $(DAT_FILES)
    @echo PNG_FILES: $(PNG_FILES)</code></pre>
        </div>
      </div>
      </article>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/make-novice">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
